<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title >Kaanh Intelligence</title>
    <link rel='stylesheet' href='lib/style.css' />
    <script src="external/jquery/jquery.js"></script>
    <script src="lib/jquery-ui.js"></script>
    <script src="lib/echarts.js"></script>
    <script src="lib/js.cookie.js"></script>
    <script src="Build/UnityLoader.js"></script>
    <script src="lib/FileSaver.js"></script>
    <title>Servo Press Monitor</title>
    <link href="lib/jquery-ui.css" rel="stylesheet">
    <link href="lib/jquery-ui.css" rel="stylesheet">
    <!--<script src="ControllerJS.js"></script>-->
</head>
<style>
    body{
        font-family: "Trebuchet MS", sans-serif;
        margin: 50px;
    }
    .demoHeaders {
        margin-top: 2em;
    }
    #dialog-link {
        padding: .4em 1em .4em 20px;
        text-decoration: none;
        position: relative;
    }
    #dialog-link span.ui-icon {
        margin: 0 5px 0 0;
        position: absolute;
        left: .2em;
        top: 50%;
        margin-top: -8px;
    }
    #icons {
        margin: 0;
        padding: 0;
    }
    #icons li {
        margin: 2px;
        position: relative;
        padding: 4px 0;
        cursor: pointer;
        float: left;
        list-style: none;
    }
    #icons span.ui-icon {
        float: left;
        margin: 0 4px;
    }
    .fakewindowcontain .ui-widget-overlay {
        position: absolute;
    }
    select {
        width: 200px;
    }
    html {
        box-sizing: border-box;
    }
    *, *:before, *:after {
        box-sizing: inherit;
    }

    #gameContainer {
        width: 100vw;
        height: 100vh;
    }
    canvas {
        width: 100%;
        height: 100%;
        display: block;
    }

    .logo {
        display: block;
        width: max-width: 80vw;
        height: max-height: 60vh;
    }

    .progress {
        margin: 1.5em;
        border: 1px solid white;
        width: 50vw;
        display: none;
    }
    .progress .full {
        margin: 2px;
        background: white;
        height: 1em;
        transform-origin: top left;
    }

    #loader {
        position: absolute;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .spinner,
    .spinner:after {
        border-radius: 50%;
        width: 5em;
        height: 5em;
    }
    .spinner {
        margin: 10px;
        font-size: 10px;
        position: relative;
        text-indent: -9999em;

        transform: translateZ(0);
        animation: spinner-spin 1.1s infinite linear;
    }
    @keyframes spinner-spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>
<body>
<p id="title_id"></p>
<input id="serverIP" placeholder="Enter server ip"/>
<select id="language_select">
    <option value="eng" >English</option>
    <option value="chs" >简体中文</option>
</select>
<div id="main" style="width: 1100px; height: 600px; margin-left: auto; margin-right: auto; margin-top: 10px;background-color: #5c5c5c">

    <div id="chart_dom" style="width: 50%;height: 100%; float: left;background-color: beige;">
        <div id="interface_div" style="width: 250px">

        </div>
        <div id="interface_div_duodian" style="width: 250px">
            <div id="enable_div"></div>
            <button id="manual_btn" >Manual</button>
            <button id="auto_btn">Auto</button>
            <div id="manual_div"></div>
            <div id="auto_div"></div>
        </div>
    </div>
    <div style="width: 50%;height: 100%; float:left">
        <div id="gameContainer"  style="width: 100%;height: 100%"></div>
        <div id="loader" style="width: 100%;height: 100%;left: auto">
            <!--<img class="logo" src="logo.png">-->
            <div class="spinner" style="width: 50%;float: left"></div>
            <div class="progress" style="width: 50%;float: left"><div class="full" ></div></div>
        </div>
    </div>
</div>

<!--Unity 3D-->
<script>
    var show3D=true;
    if (show3D) {
        var gameInstance = UnityLoader.instantiate("gameContainer", "Build/8.json", {onProgress: UnityProgress});
    }

    //unity 加载完成后的回调
    function AfterUnityShow() {
        Initial();
        $("#gameContainer").show();
        $("#chart_dom").show();
    }

    function UnityProgress(gameInstance, progress) {
        if (!gameInstance.Module) {
            return;
        }
        const loader = document.querySelector("#loader");
        if (!gameInstance.progress) {
            const progress = document.querySelector("#loader .progress");
            progress.style.display = "block";
            gameInstance.progress = progress.querySelector(".full");
            loader.querySelector(".spinner").style.display = "none";
        }
        gameInstance.progress.style.transform = `scaleX(${progress})`;
        if (progress === 1 && !gameInstance.removeTimeout) {
            gameInstance.removeTimeout = setTimeout(function() {
                loader.style.display = "none";
                AfterUnityShow();
            }, 5000);

        }
    }

</script>

<script src="lib/ControllerJS.js"></script>
<script type="text/javascript">
    // console.log(abc(5,6));
</script>
<script type="text/javascript">
    function downloadText(data) {
        // var blob = new Blob([JSON.stringify(data)], { type: "text/plain;charset=utf-8" });
        var blob = new Blob([data], { type: "text/plain;charset=utf-8" });
        saveAs(blob, "export.txt");
    }
    // downloadText("der");
</script>
<script type="text/javascript" language="javascript" charset="big5">
    var showDuodian=false;
    var language="eng";
    $("#gameContainer").hide();
    $("#chart_dom").hide();
    $("#interface_div_duodian").hide();
    $("#manual_div").hide();
    $("#auto_div").hide();

    if (Cookies.get("var")!=null){
        language=Cookies.get("var");
    }
    else {
        language=$("select#language_select").val();
    }

    $("select#language_select").change(function(){
        console.log($(this).val());
        language=$(this).val();
        Cookies.set("var",language);
        location.reload();
    });
    var xmlDoc;
    var robotXmlStr;

    // var serverIP="ws://192.168.1.4:5866";
    var serverIP="ws://127.0.0.1:5866";

    var ip_addr = document.location.hostname;
    if (ip_addr!==""&&ip_addr.indexOf("localhost")<0 && ip_addr.indexOf("file")<0){
        serverIP="ws://"+ip_addr+":5866";
    }

    console.log("ip address"+ip_addr+"/ControllerUI");

    document.getElementById("serverIP").onchange=function(){
        var str=document.getElementById("serverIP").value;
        if (str!==""&&str!=null){
            serverIP="ws://"+str+":5866";
             console.log(serverIP);
             ws.close();
            buildWS();
            setTimeout("SendCmd('2&1&0&0&0&GetXml --check_none')",4000);
             }
    };

    document.getElementById("serverIP").onclick=function(){
        if (show3D){
            var pastedtext= prompt("Please paste here:", "placeholder");
            // document.getElementById("serverIP").valueOf(pastedtext);
            $("#serverIP").val(pastedtext);
            serverIP="ws://"+pastedtext+":5866";
            console.log(serverIP);
            ws.close();
            buildWS();
            setTimeout(QueryXml,4000);
        }
    };

    function Initial() {

        if (show3D){
            setInterval(GetPartPq,100);
            if (ip_addr!==""&&ip_addr.indexOf("localhost")<0 && ip_addr.indexOf("file")<0){
                if (gameInstance!=null){
                    setTimeout(function () {
                        gameInstance.SendMessage("empt","GetUrlFromJs",ip_addr);
                    },1000);
                }
                console.log("send to unity address: "+ip_addr+"/ControllerUI");
            }

            if (gameInstance!=null&&robotXmlStr!=null&&robotXmlStr!==""){
                console.log("send xml to Unity:"+robotXmlStr);
                gameInstance.SendMessage("empt","GetRobotXmlFromJS",robotXmlStr);
            }

        }
    }

    function ReturnUI_Text(str) {
        if (str!==null&&str!==""){
            var str_list=str.split('|');
            switch (language) {
                case "eng":
                    return str_list[0];
                case "chs":
                    return str_list[1];
                default:
                    return null;

            }
        }
    }

    //业务
    //获得xml后的回调
    function GetXmlDoc(data){
        $("#interface_div").empty();
        // console.log(data);
        robotXmlStr=data;
        var parser=new DOMParser();
        xmlDoc=parser.parseFromString(data,"text/xml");


        //robot name
        var root_ele=xmlDoc.getElementsByTagName("ControlServer");
        var robot_name=root_ele[0].getAttribute("name");
        console.log("robot name: "+robot_name);
        if (robot_name.indexOf("stewart")!==-1){
            showDuodian=true;
            ShowDuodianInterface();
        }
        //plan_interface
        var interface_node=xmlDoc.getElementsByTagName("InterfaceRoot");
        GetUI_ID_List(interface_node[0]);
        //duodian
        if (showDuodian){
            ShowInterface(interface_node[0],"Simulator",document.getElementById("enable_div"));
            ShowInterface(interface_node[0],"Auto",document.getElementById("auto_div"));
            ShowInterface(interface_node[0],"Manual",document.getElementById("manual_div"));
        }
        else {
            ShowInterface(interface_node[0],"Teaching|",document.getElementById("interface_div"));
            ShowInterface(interface_node[0],"My CMD|CMD",document.getElementById("interface_div"));
        }

        // $("#serverIP").hide();
        // $("#language_select").hide();

        // ShowInterface(interface_node[0],"My query|Query",document.getElementById("interface_div"));
        SetUITheme();
        // ShowPlanInterface(interface_node[0]);
    }

    //按钮的回调
    function AfterBtnClick(str) {
        //储存cmd的返回操作

        // console.log("After btn click: "+str);
        if (str.indexOf("mm --stop")!=-1){
            manual_stop=true;
            manual_start=false;
        }

        if (str.indexOf("am --stop")!=-1){
            auto_stop=true;
            auto_start=false;
        }
        if (str.indexOf("mm --start")!=-1){
            manual_start=true;
            manual_stop=false;
            console.log("mm --start");
        }
        if (str.indexOf("am --start")!=-1){
            auto_start=true;
            auto_stop=false;
        }
    }

    function ReGenerateUI() {
        $("#interface_div").empty();
        //setTimeout(QueryXml,3500);
        QueryXml();
    }

    function ShowDuodianInterface() {
        if (false){

            $("#interface_div_duodian").show();
            document.getElementById("manual_btn").innerText=(ReturnUI_Text("Manual|手动"));
            document.getElementById("auto_btn").innerText=(ReturnUI_Text("Auto|自动"));
            document.title=ReturnUI_Text("Auto|自动");
            var manual_init=true;
            var manual_start=false;
            var manual_stop=true;
            var auto_init=false;
            var auto_start=false;
            var auto_stop=true;

            function UpdateView() {
                if (manual_init&&auto_stop){
                    $("#manual_div").show();
                    $("#auto_div").hide();
                }
                if (auto_init&&manual_stop){
                    $("#manual_div").hide();
                    $("#auto_div").show();
                }


                if (manual_start){
                    $("#id_8").show();
                    $("#id_9").show();
                    document.getElementById("auto_btn").disabled=true;
                    document.getElementById("auto_btn").style="color:gray";
                }
                if (manual_stop){
                    $("#id_8").hide();
                    $("#id_9").hide();
                    document.getElementById("auto_btn").disabled=false;
                    document.getElementById("auto_btn").style="color:black";
                }
                if (auto_start){

                    document.getElementById("manual_btn").disabled=true;
                    document.getElementById("manual_btn").style="color:gray";
                }
                if (auto_stop){

                    document.getElementById("manual_btn").disabled=false;
                    document.getElementById("manual_btn").style="color:black";
                }

            }

            setInterval(UpdateView,100);

            document.getElementById("manual_btn").onclick=function () {
                if (auto_stop){
                    // $("#manual_div").show();
                    // $("#auto_div").hide();
                    manual_init=true;
                    auto_init=false;
                }
            };

            document.getElementById("auto_btn").onclick=function () {
                if (manual_stop){
                    // $("#manual_div").hide();
                    // $("#auto_div").show();
                    manual_init=false;
                    auto_init=true;

                }
            };
        }
    }
    if (showDuodian){

        $("#interface_div_duodian").show();
        document.getElementById("manual_btn").innerText=(ReturnUI_Text("Manual|手动"));
        document.getElementById("auto_btn").innerText=(ReturnUI_Text("Auto|自动"));
        document.title=ReturnUI_Text("Auto|自动");
        var manual_init=true;
        var manual_start=false;
        var manual_stop=true;
        var auto_init=false;
        var auto_start=false;
        var auto_stop=true;

        function UpdateView() {
            if (manual_init&&auto_stop){
                $("#manual_div").show();
                $("#auto_div").hide();
            }
            if (auto_init&&manual_stop){
                $("#manual_div").hide();
                $("#auto_div").show();
            }


            if (manual_start){
                $("#id_8").show();
                $("#id_9").show();
                document.getElementById("auto_btn").disabled=true;
                document.getElementById("auto_btn").style="color:gray";
            }
            if (manual_stop){
                $("#id_8").hide();
                $("#id_9").hide();
                document.getElementById("auto_btn").disabled=false;
                document.getElementById("auto_btn").style="color:black";
            }
            if (auto_start){

                document.getElementById("manual_btn").disabled=true;
                document.getElementById("manual_btn").style="color:gray";
            }
            if (auto_stop){

                document.getElementById("manual_btn").disabled=false;
                document.getElementById("manual_btn").style="color:black";
            }

        }

        setInterval(UpdateView,100);

        document.getElementById("manual_btn").onclick=function () {
            if (auto_stop){
                // $("#manual_div").show();
                // $("#auto_div").hide();
                manual_init=true;
                auto_init=false;
            }
        };

        document.getElementById("auto_btn").onclick=function () {
            if (manual_stop){
                // $("#manual_div").hide();
                // $("#auto_div").show();
                manual_init=false;
                auto_init=true;

            }
        };
    }


</script>

<script type="text/javascript">
    var ws;
    buildWS();
    setTimeout(QueryXml,3500);
    $("button").button();
    function SetUITheme(){
        setTimeout("$(\"button\").button()",1050);
        setTimeout("$(\"button\").width(80)",1050);
        setTimeout("$(\"#interface_div\").show()",1065);

        setTimeout(function () {
            if (!show3D){
                $("#chart_dom").show();
            }
        },2065);
    }
</script>
</body>
</html>
