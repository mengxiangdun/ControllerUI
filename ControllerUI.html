<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title >Kaanh Intelligence</title>
    <link rel='stylesheet' href='./style.css' />
    <script src="external/jquery/jquery.js"></script>
    <script src="jquery-ui.js"></script>
    <script src="echarts.js"></script>
    <script src="js.cookie.js"></script>
    <script src="Build/UnityLoader.js"></script>
    <title>Servo Press Monitor</title>
    <link href="jquery-ui.css" rel="stylesheet">
    <link href="/jquery-ui.css" rel="stylesheet">
</head>
<style>
    body{
        font-family: "Trebuchet MS", sans-serif;
        margin: 50px;
    }
    .demoHeaders {
        margin-top: 2em;
    }
    #dialog-link {
        padding: .4em 1em .4em 20px;
        text-decoration: none;
        position: relative;
    }
    #dialog-link span.ui-icon {
        margin: 0 5px 0 0;
        position: absolute;
        left: .2em;
        top: 50%;
        margin-top: -8px;
    }
    #icons {
        margin: 0;
        padding: 0;
    }
    #icons li {
        margin: 2px;
        position: relative;
        padding: 4px 0;
        cursor: pointer;
        float: left;
        list-style: none;
    }
    #icons span.ui-icon {
        float: left;
        margin: 0 4px;
    }
    .fakewindowcontain .ui-widget-overlay {
        position: absolute;
    }
    select {
        width: 200px;
    }
    html {
        box-sizing: border-box;
    }
    *, *:before, *:after {
        box-sizing: inherit;
    }

    #gameContainer {
        width: 100vw;
        height: 100vh;
    }
    canvas {
        width: 100%;
        height: 100%;
        display: block;
    }

    .logo {
        display: block;
        width: max-width: 80vw;
        height: max-height: 60vh;
    }

    .progress {
        margin: 1.5em;
        border: 1px solid white;
        width: 50vw;
        display: none;
    }
    .progress .full {
        margin: 2px;
        background: white;
        height: 1em;
        transform-origin: top left;
    }

    #loader {
        position: absolute;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .spinner,
    .spinner:after {
        border-radius: 50%;
        width: 5em;
        height: 5em;
    }
    .spinner {
        margin: 10px;
        font-size: 10px;
        position: relative;
        text-indent: -9999em;

        transform: translateZ(0);
        animation: spinner-spin 1.1s infinite linear;
    }
    @keyframes spinner-spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>
<body>
<p id="title_id"></p>
<input id="serverIP" placeholder="Enter server ip"/>
<select id="language_select">
    <option value="eng" >English</option>
    <option value="chs" >简体中文</option>
</select>
<div id="main" style="width: 1100px; height: 600px; margin-left: auto; margin-right: auto; margin-top: 10px;background-color: #5c5c5c">

    <div id="chart_dom" style="width: 50%;height: 100%; float: left;background-color: beige;">
        <!--<input id="serverIP" placeholder="Enter server ip"/>-->
        <!--<select id="language_select">-->
            <!--<option value="eng" >English</option>-->
            <!--<option value="chs" >简体中文</option>-->
        <!--</select>-->
        <div id="interface_div" style="width: 250px">
            <div id="enable_div"></div>
            <button id="manual_btn" >Manual</button>
            <button id="auto_btn">Auto</button>
            <div id="manual_div"></div>
            <div id="auto_div"></div>
        </div>
    </div>
    <div style="width: 50%;height: 100%; float:left">
        <div id="gameContainer"  style="width: 100%;height: 100%"></div>
        <div id="loader" style="width: 100%;height: 100%;left: auto">
            <!--<img class="logo" src="logo.png">-->
            <div class="spinner" style="width: 50%;float: left"></div>
            <div class="progress" style="width: 50%;float: left"><div class="full" ></div></div>
        </div>
    </div>
</div>

<!--unity-->
<script>
    var gameInstance = UnityLoader.instantiate("gameContainer", "Build/8.json", {onProgress: UnityProgress});
    function UnityProgress(gameInstance, progress) {
        if (!gameInstance.Module) {
            return;
        }
        const loader = document.querySelector("#loader");
        if (!gameInstance.progress) {
            const progress = document.querySelector("#loader .progress");
            progress.style.display = "block";
            gameInstance.progress = progress.querySelector(".full");
            loader.querySelector(".spinner").style.display = "none";
        }
        gameInstance.progress.style.transform = `scaleX(${progress})`;
        if (progress === 1 && !gameInstance.removeTimeout) {
            gameInstance.removeTimeout = setTimeout(function() {
                loader.style.display = "none";

            }, 2000);

        }
    }
</script>

<script src="/socket.io/socket.io.js"></script>
<script src="test.js"></script>
<script type="text/javascript">
    console.log(abc(5,6));
</script>
<script type="text/javascript" language="javascript" charset="big5">
    var language="eng";
    $("#gameContainer").hide();
    $("#chart_dom").hide();
    //$("#main").hide();
    $("#manual_div").hide();
    $("#auto_div").hide();
    if (Cookies.get("var")!=null){
        language=Cookies.get("var");
    }
    else {
        language=$("select#language_select").val();
    }

    // document.getElementById("title_id").innerText=(ReturnUI_Text("Simulator|模拟器"));
    document.getElementById("manual_btn").innerText=(ReturnUI_Text("Manual|手动"));
    document.getElementById("auto_btn").innerText=(ReturnUI_Text("Auto|自动"));
    // document.getElementById("enable_btn").innerText=(ReturnUI_Text("Enable|使能"));
    // document.getElementById("disable_btn").innerText=(ReturnUI_Text("Disable|去使能"));
    document.title=ReturnUI_Text("Auto|自动");
    console.log(language);
    $("select#language_select").change(function(){
        console.log($(this).val());
        language=$(this).val();
        Cookies.set("var",language);
        location.reload();
    });
    var xmlDoc;
    var setupList=[];
    // var serverIP="ws://10.10.10.126:5866";
    var serverIP="ws://127.0.0.1:5866";
    var cmd_code_list=[];//发送的命令代码列表
    var cmd_code_return_list=[];//需要处理返回值的方式列表
    var ui_id_list=[];//ui id 变量名列表
    var ui_id_value_list=[];// ui id 列表
    var language_ui_id=[];//中英文切换
    var language_ui_text=[];
    var manual_init=true;
    var manual_start=false;
    var manual_stop=true;
    var auto_init=false;
    var auto_start=false;
    var auto_stop=true;
    var ip_addr = document.location.hostname;

    if (ip_addr.indexOf("localhost")<0 && ip_addr.indexOf("file")<0){
        serverIP="ws://"+ip_addr+":5866";
    }

    console.log("ip address"+ip_addr+"/ControllerUI");

    document.getElementById("serverIP").onchange=function(){
        var str=document.getElementById("serverIP").value;
        if (str!=""&&str!=null){
            serverIP="ws://"+str+":5866";
             console.log(serverIP);
             ws.close();
            buildWS();
            setTimeout("SendCmd('2&1&0&0&0&GetXml --check_none')",4000);
             }
    }

    document.getElementById("serverIP").onclick=function(){
        var pastedtext= prompt("Please paste here:", "placeholder");
        // document.getElementById("serverIP").valueOf(pastedtext);
        $("#serverIP").val(pastedtext);
        serverIP="ws://"+pastedtext+":5866";
        console.log(serverIP);
        ws.close();
        buildWS();
        setTimeout("SendCmd('2&1&0&0&0&GetXml --check_none')",4000);

    }

    document.getElementById("manual_btn").onclick=function () {
        if (auto_stop){
            // $("#manual_div").show();
            // $("#auto_div").hide();
            manual_init=true;
            auto_init=false;

        }

    }

    document.getElementById("auto_btn").onclick=function () {
        if (manual_stop){
            // $("#manual_div").hide();
            // $("#auto_div").show();
            manual_init=false;
            auto_init=true;

        }
    }

    // document.getElementById("enable_btn").onmousedown=function(){
    //     //setInterval(ReadFromServer,1000);
    // }
    var repeat_read;
    var initialized=false;

    function Initial() {
        SendCmd("0&1&"+now+"&0&0&"+"mm --stop");
        SendCmd("0&1&"+now+"&0&0&"+"am --stop");
        // SendCmd("0&1&"+now+"&0&0&"+str_2[j]);
        setInterval(ReadFromServer,100);
        if (ip_addr.indexOf("localhost")<0 && ip_addr.indexOf("file")<0){
             gameInstance.SendMessage("empt","GetUrlFromJs",ip_addr+"/ControllerUI");
         }

    }

    // document.getElementById("enable_btn").onclick=function () {
    //     if (!initialized){
    //         SendCmd("0&1&0&0&0&"+"ds\n md\n en\n");
    //         if (ip_addr.indexOf("localhost")===-1){
    //             gameInstance.SendMessage("empt","GetUrlFromJs",ip_addr+"/ControllerUI");
    //         }
    //
    //         initialized=true;
    //     }
    //     repeat_read= setInterval(ReadFromServer,100);
    //     //ws.close();
    // }
    //
    // document.getElementById("disable_btn").onclick=function () {
    //     clearInterval(repeat_read);
    // }


    function UpdateView() {
            if (manual_init&&auto_stop){
                $("#manual_div").show();
                $("#auto_div").hide();
            }
            if (auto_init&&manual_stop){
                $("#manual_div").hide();
                $("#auto_div").show();
            }


            if (manual_start){
                $("#id_8").show();
                $("#id_9").show();
                document.getElementById("auto_btn").disabled=true;
                document.getElementById("auto_btn").style="color:gray";
            }
            if (manual_stop){
                $("#id_8").hide();
                $("#id_9").hide();
                document.getElementById("auto_btn").disabled=false;
                document.getElementById("auto_btn").style="color:black";
            }
        if (auto_start){

            document.getElementById("manual_btn").disabled=true;
            document.getElementById("manual_btn").style="color:gray";
        }
        if (auto_stop){

            document.getElementById("manual_btn").disabled=false;
            document.getElementById("manual_btn").style="color:black";
        }
        //     if ($('input[type="radio"][name="radio"]:checked').val()==="1"){
        //         if (auto_stop){
        //             // $("#manual_div").show();
        //             // $("#auto_div").hide();
        //             $("input[type='radio'][name='radio'][value='2']").removeAttr("checked", "checked");
        //             $("input[type='radio'][name='radio'][value='1']").prop("checked", "checked");
        //
        //             manual_init=true;
        //             auto_init=false;
        //         }
        //         else {
        //             $("input[type='radio'][name='radio'][value='1']").removeAttr("checked");
        //             $("input[type='radio'][name='radio'][value='2']").prop("checked", "checked");
        //
        //         }
        //     }
        // if ($('input[type="radio"][name="radio"]:checked').val()==="2"){
        //     if (manual_stop){
        //         // $("#manual_div").show();
        //         // $("#auto_div").hide();
        //         manual_init=false;
        //         auto_init=true;
        //         $("input[type='radio'][name='radio'][value='1']").removeAttr("checked");
        //         $("input[type='radio'][name='radio'][value='2']").prop("checked", "checked");
        //     }
        //     else {
        //         $("input[type='radio'][name='radio'][value='2']").removeAttr("checked");
        //         $("input[type='radio'][name='radio'][value='1']").prop("checked", "checked");
        //     }
        // }
        // console.log($('input[type="radio"][name="radio"]:checked').val());
    }

    setInterval(UpdateView,100);

    function GetXmlDoc(data){
        //
        // console.log(data);
        var parser=new DOMParser();
        xmlDoc=parser.parseFromString(data,"text/xml");
        //master
        // var master_node=xmlDoc.getElementsByTagName("master");
        // printNodeName(master_node[0],"");

        //plan_interface
        var interface_node=xmlDoc.getElementsByTagName("interface_root");
        ShowPlanInterface(interface_node[0]);

    }

    function ShowPlanInterface(node){

        GetUI_ID_List(node);
        var cmd_interface_pool_node=node.getElementsByTagName("cmd_interface_pool_object");

        var cmd_panel_node=cmd_interface_pool_node[0].childNodes;
        for (var i=0;i<cmd_panel_node.length;i++){
            if (cmd_panel_node[i].nodeType===1&&cmd_panel_node[i].nodeName==="panel"){
                if (cmd_panel_node[i].getAttribute("text")==="Simulator|模拟器") {
                    CreatePanel(cmd_panel_node[i],document.getElementById("enable_div"));
                }
                if (cmd_panel_node[i].getAttribute("text")==="Manual|手动") {
                    CreatePanel(cmd_panel_node[i],document.getElementById("manual_div"));
                }
                if (cmd_panel_node[i].getAttribute("text")==="Auto|自动") {
                    CreatePanel(cmd_panel_node[i],document.getElementById("auto_div"));
                }
            }

        }

        var query_interface_pool_node=node.getElementsByTagName("query_interface_pool_object");
        var query_panel_node=query_interface_pool_node[0].childNodes;
        for (var j = 0; j < query_panel_node.length;j++){
            if (query_panel_node[j].nodeType===1&&query_panel_node[j].nodeName==="panel"){
                CreatePanel(query_panel_node[j],document.getElementById("interface_div"));
            }

        }

        SetUITheme();
    }

    function GetUI_ID_List(node) {
        var id_pool_node=node.getElementsByTagName("ui_id_pool_object");
        var id_list=id_pool_node[0].childNodes;
        for (var i=0;i<id_list.length;i++){

            if (id_list[i].nodeType===1){
                ui_id_list[ui_id_list.length]=id_list[i].nodeName;
                ui_id_value_list[ui_id_value_list.length]=id_list[i].getAttribute("value");
            }
        }
    }

    function ReturnUI_ID(str) {
        var index_1=ui_id_list.indexOf(str);
        if (index_1!=-1){
            return ui_id_value_list[index_1];

        }else {return null;}
    }

    function ReturnUI_Text(str) {
        var str_list=str.split('|');
        switch (language) {
            case "eng":
                return str_list[0];
            case "chs":
                return str_list[1];
            default:
                return null;

        }

    }

    function CreatePanel(node,father) {
        var panel_id=ReturnUI_ID( node.getAttribute("id"));
        var panel_text=node.getAttribute("text");
        var div_syncm=document.createElement("fieldset");
        div_syncm.style="width:400px";
        div_syncm.id=panel_id;
        div_syncm.innerText=ReturnUI_Text(panel_text);
        div_syncm.appendChild(document.createElement("p"));
        language_ui_id[language_ui_id.length]=panel_id;
        language_ui_text[language_ui_text.length]=panel_text;
        // console.log(div_syncm.innerText);
        var sonNodes=node.childNodes;
        for (var j=0;j<sonNodes.length;j++){
            if (sonNodes[j].nodeType===1){
                if (sonNodes[j].nodeName==="panel"){
                    CreatePanel(sonNodes[j],div_syncm);
                }
                if (sonNodes[j].nodeName==="input"){
                    CreateInput(sonNodes[j],div_syncm);
                }
                if (sonNodes[j].nodeName==="button"){
                    CreateButton(sonNodes[j],div_syncm);
                }
                if (sonNodes[j].nodeName==="label"){
                    CreateLabel(sonNodes[j],div_syncm);
                }
            }
        }
        father.appendChild(document.createElement("h"));
        father.appendChild(div_syncm);
    }

    function CreateInput(node,father) {
        var input_para=document.createElement("b");
        input_para.innerText="  "+node.getAttribute("parameter");
        father.appendChild(input_para);
        var input_div=document.createElement("input");
        input_div.id=ReturnUI_ID(node.getAttribute("id"));
        input_div.value=node.getAttribute("default");
        input_div.style="width:80px";
        father.appendChild(input_div);
    }

    function CreateLabel(node,father) {
        var input_para=document.createElement("input");
        input_para.id=ReturnUI_ID(node.getAttribute("id"));
        // console.log("label id:"+input_para.id);
        // input_para.innerText="  ";
        input_para.setAttribute("type","text");
        input_para.setAttribute("value","");
        father.appendChild(input_para);
        // var input_div=document.createElement("input");
        // input_div.id=node.getAttribute("id");
        // input_div.value=node.getAttribute("default");
        // input_div.style="width:80px";
        // father.appendChild(input_div);
    }

    function CreateButton(node,father) {

        var btn_cmd=document.createElement("button");

        // btn_cmd.innerHTML="<button>"+node.getAttribute('text')+"</button>";
        var btn_text=node.getAttribute('text');
        btn_cmd.innerText=ReturnUI_Text(btn_text);
        var btn_id=ReturnUI_ID(node.getAttribute("id"));
        btn_cmd.id=btn_id;
        language_ui_id[language_ui_id.length]=btn_id;
        language_ui_text[language_ui_text.length]=btn_text;

        btn_cmd.style="width: 80px; position: relative; margin-left: 20px;margin-top: 10px";
        father.appendChild(btn_cmd);

        // $("#"+btn_id).css({position: "absolute",'top':100,'left':50,'z-index':2});

        if (node.getAttribute("cmd")!=null){

            var cmd_str_1=node.getAttribute("cmd");
            var cmd_return_str=node.getAttribute("return_attached");
            if (node.getAttribute("repeat")!=1){//down repeat
                btn_cmd.onclick=function(){
                    Btn_cmd_onclick(cmd_str_1,cmd_return_str);
                }
            }
            if (node.getAttribute("repeat")==="1"){//down repeat
                console.log("repeat");
                var repeat_1;
                btn_cmd.onmousedown=function(){
                   repeat_1=  setInterval(Btn_cmd_onclick_repeat(cmd_str_1,cmd_return_str),50);
                }
                btn_cmd.onmouseup=function () {
                    clearInterval(repeat_1);
                }
                
            }
        }
        if (node.getAttribute("query_item")!=null){
            var query_str=node.getAttribute("query_item");
            var query_return_str=node.getAttribute("return_attached");
            btn_cmd.onclick=function () {
                Btn_query_onclick(query_str,query_return_str)
            }
        }
    }


    function Btn_cmd_onclick_repeat(id,id2) {
        return function()
        {
            //foo(id,id2);
           Btn_cmd_onclick(id,id2);
        }
    }

    function Btn_cmd_onclick(str,return_str){
        if (str.indexOf("$")!=-1) {
            // console.log(str);
            var index_1 = str.indexOf("{");
            // console.log("index_1: " + index_1);

            var index_2 = str.indexOf("}");
            // console.log("index_2: " + index_2);
            var id_str = str.substr(index_1 + 1, index_2 - index_1 - 1);
            // console.log(id_str);
            var id_value = $("#" + id_str).val();
            // console.log(id_value);
            var old_str="${"+id_str+"}";
            // console.log("old str "+old_str);
            // console.log(str.replace(old_str,id_value));
            Btn_cmd_onclick(str.replace(old_str,id_value));
        }

        if (str.indexOf("$")==-1){
            var myDate=new Date();
            var now=myDate.getTime();
            // console.log("time:"+now);

            // console.log("0&1&"+now+"&0&0&"+str);
            var str_2=str.split(';');
            for (var j=0;j<str_2.length;j++){
                SendCmd("0&1&"+now+"&0&0&"+str_2[j]);
            }


            cmd_code_list[cmd_code_list.length]=now;//储存已发送的cmd code
            cmd_code_return_list[cmd_code_return_list.length]=return_str;//储存cmd的返回操作

            if (str.indexOf("mm --stop")!=-1){
                manual_stop=true;
                manual_start=false;
            }

            if (str.indexOf("am --stop")!=-1){
                auto_stop=true;
                auto_start=false;
            }
            if (str.indexOf("mm --start")!=-1){
                manual_start=true;
                manual_stop=false;
            }
            if (str.indexOf("am --start")!=-1){
                auto_start=true;
                auto_stop=false;
            }
        }
    }

    function Btn_query_onclick(str,return_str){
        var myDate=new Date();
        var now=myDate.getTime();
        // var now=myDate.myDate.toLocaleTimeString();
        // console.log("time:"+now);

        // console.log("send :"+"5&1&"+now+"&0&0&"+str);
        SendCmd("5&1&"+now+"&0&0&"+str);
        cmd_code_list[cmd_code_list.length]=now;//储存已发送的cmd code
        cmd_code_return_list[cmd_code_return_list.length]=return_str;//储存cmd的返回操作

    }

</script>


<script type="text/javascript">

    var ws;

    function PackBotCmd(str) {
        //1&1&0&0&0&Read --check_none
        var strArray=str.split("&");
        if (strArray.length>3){
            var cmd_id=parseInt(strArray[0]);
            var cmd_option=parseInt((strArray[1]));
            var cmd_code=parseInt((strArray[2]));

            // console.log("res-1:"+cmd_code);
            var res_2=parseInt((strArray[3]));
            var res_3=parseInt((strArray[4]));

            var mes_length=strArray[5].length;
            var buffer=new ArrayBuffer(40+mes_length);
            var headView=new DataView(buffer);
            headView.setInt32(0,mes_length,true);
            headView.setInt32(4,cmd_id,true);
            headView.setInt32(8,cmd_option,true);
            headView.setFloat64(16,cmd_code,true);
            // console.log("cmd_code:"+headView.getFloat64(16,true));
            headView.setInt32(24,res_2,true);
            headView.setInt32(32,res_3,true);
            for (var i=0;i<mes_length;i++){
                headView.setUint8(40+i,strArray[5].charCodeAt(i));
            }

            ws.send(headView.buffer);
            // console.log("send cmd"+headView.buffer.byteLength);

        }
    }

    //可以处理中文
    function Utf8ArrayToStr(array) {
        var out, i, len, c;
        var char2, char3;

        out = "";
        len = array.length;
        i = 0;
        while(i < len) {
            c = array[i++];
            switch(c >> 4)
            {
                case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7:
                // 0xxxxxxx
                out += String.fromCharCode(c);
                break;
                case 12: case 13:
                // 110x xxxx   10xx xxxx
                char2 = array[i++];
                out += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));
                break;
                case 14:
                    // 1110 xxxx  10xx xxxx  10xx xxxx
                    char2 = array[i++];
                    char3 = array[i++];
                    out += String.fromCharCode(((c & 0x0F) << 12) |
                        ((char2 & 0x3F) << 6) |
                        ((char3 & 0x3F) << 0));
                    break;
            }
        }

        return out;
    }

    function AnalizeBotData(buffer) {
        var dataView=new DataView(buffer);
        var cmd_length=dataView.getInt32(0);
        // console.log("receive cmd_length:"+cmd_length);
        var cmd_id=dataView.getInt32(4,true);
        // console.log("receive cmd_id:"+cmd_id);
        var cmd_code=dataView.getFloat64(16,true);
        // console.log(("receive cmd_code:"+cmd_code));

        var getMess;

        //return xml
        if (cmd_id===2){
            // getMess=String.fromCharCode.apply(null,new Uint8Array(buffer,40));
            getMess=Utf8ArrayToStr(new Uint8Array(buffer,40));
            // console.log(getMess);
            GetXmlDoc(getMess);
        }
        //return float message
        if (cmd_id===0){
            // var step=new Array();
            // for(var i=0;i<(dataView.length-40)/8;i++){
            //     step[i]=dataView.getFloat64(432+i*8);
            // }

        }
        //return float
        if (cmd_id===1){

            var pq="";
            // console.log("data view length:"+buffer.byteLength)
            for(var i=0;i<(buffer.byteLength-40)/8;i++){
                if (i!=0){
                    pq+="&"+dataView.getFloat64(40+i*8,true).toString();
                }
                if (i===0){
                    pq+=dataView.getFloat64(40+i*8,true).toString();
                }


            }
            //console.log("send PQ to UNity:"+pq);
            gameInstance.SendMessage("empt","ReceiveDataFromJs",pq);

           //  var return_str=String.fromCharCode.apply(null,new Uint8Array(buffer,40));
           // if (cmd_code_list.indexOf(cmd_code)!=-1){
           //     var cmd_code_index=cmd_code_list.indexOf(cmd_code);
           //     var code_return_str=cmd_code_return_list[cmd_code_index];
           //
           //     var return_str_splitlist=return_str.split(' ');
           //     var code_return_str_splitList=code_return_str.split(' ');
           //     for (var i=0;i<return_str_splitlist.length;i++){
           //         if (code_return_str_splitList[i].indexOf("$")!=-1);
           //         var index_1=code_return_str_splitList[i].indexOf(("{"));
           //         var index_2=code_return_str_splitList[i].indexOf("}");
           //         var ui_id_str=code_return_str_splitList[i].substr(index_1+1,index_2-index_1-1);
           //         var valude_str=return_str_splitlist[i].substr(index_1-1,return_str_splitlist[i].length-index_1+1);
           //         $("#" + ui_id_str).val=valude_str;
           //     }
           //     cmd_code_list.splice(cmd_code_index,1);
           //     cmd_code_return_list.splice(cmd_code_index,1);
           //     //Motion -m=5 --pos=6
           //     //Motion -m=${id_4} --pos=
           // }
        }

        //return query
        if (cmd_id===5){
            var return_str=String.fromCharCode.apply(null,new Uint8Array(buffer,40));
            // console.log("receive query :"+return_str);
            if (cmd_code_list.indexOf(cmd_code)!=-1){
                var cmd_code_index=cmd_code_list.indexOf(cmd_code);
                // console.log("cmd_code_index: "+cmd_code_index);
                var code_return_str=cmd_code_return_list[cmd_code_index];
                if (code_return_str.indexOf("$")!=-1){
                    var index_1=code_return_str.indexOf("{");
                    var index_2=code_return_str.indexOf("}");
                    var id_str=code_return_str.substr(index_1+1,index_2-index_1-1);
                    // console.log("id_str: "+id_str);
                    // $("#" + id_str).setAttribute("value",return_str);
                    $("#" + id_str).val(return_str);
                    // document.getElementById(id_str).innerText=return_str;
                    // console.log("label str:"+$("#" + id_str).value);
                }
                cmd_code_list.splice(cmd_code_index,1);
                cmd_code_return_list.splice(cmd_code_index,1);
            }
        }
    }

    function buildWS(cmd) {
        ws=new WebSocket(serverIP);

        ws.onopen=function (evt) {
            console.log("Connection open...");
            if (cmd!=null){
                SendCmd(cmd);
                console.log(cmd);
            }


        }
        ws.onmessage=function (evt) {
            if (typeof evt.data=== String){
                // console.log("Received "+evt.data);
                receiveStr=evt.data;
            }
            if (evt.data instanceof ArrayBuffer){
                // console.log("receive byte"+evt.data.byteLength);
                AnalizeBotData(evt.data);
            }


        }
        ws.onclose=function (evt) {
            console.log("closed");
        }
    }

    buildWS();

    setTimeout("SendCmd('2&1&0&0&0&GetXml --check_none')",3500);
    setTimeout("Initial()",5000);

    function SendCmd(cmd){
        switch (ws.readyState) {
            case WebSocket.CONNECTING:
                break;
            case WebSocket.OPEN:
                ws.binaryType='arraybuffer';
                PackBotCmd(cmd);
                break;
            case  WebSocket.CLOSING:
                break;
            case WebSocket.CLOSED:
                buildWS(cmd);
                //setTimeout("SendCmd(cmd)",4000);
                break;
        }
    }

    function ReadFromServer(){
        switch (ws.readyState) {
            case WebSocket.CONNECTING:
                break;
            case WebSocket.OPEN:
                ws.binaryType='arraybuffer';
                PackBotCmd("1&1&0&0&0&Read --check_none");
                //ws.send(PackBotCmd("1&1&0&0&0&Read --check_none"));
                //ws.send("hello");
                //CheckData(receiveStr);
                break;
            case  WebSocket.CLOSING:
                break;
            case WebSocket.CLOSED:
                buildWS();
                break;
        }


    }


</script>


<script type="text/javascript">
    $("#btn_0").button();
    $("#btn_1").button();
    $("#getXml").button();
    $("#saveXml").button();
    $("#auto_btn").button();
    //$("#manual_btn").button();
    $("#run").button();
    $( "#accordion" ).accordion({
        heightStyle:"content",
        collapsible: "true"

    });
    $("button").button();
    function SetUITheme(){
        setTimeout("$(\"button\").button()",1050);
        setTimeout("$(\"button\").width(80)",1050);
        setTimeout("$(\"#interface_div\").show()",1065);
        setTimeout(function () {
            $("#gameContainer").show();
            $("#chart_dom").show();
        },1065);
    }

    // $( "#interface_div_1" ).accordion({
    //     heightStyle:"content",
    //     collapsible: "true"
    //
    // });

</script>
</body>
</html>
