<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title >Kaanh Intelligence</title>
    <link rel='stylesheet' href='./style.css' />
    <script src="external/jquery/jquery.js"></script>
    <script src="jquery-ui.js"></script>
    <script src="echarts.js"></script>
    <script src="js.cookie.js"></script>
    <script src="Build/UnityLoader.js"></script>
    <title>Servo Press Monitor</title>
    <link href="jquery-ui.css" rel="stylesheet">
    <link href="/jquery-ui.css" rel="stylesheet">
</head>
<body>
<p id="title_id">Welcome to Kaanh Intelligence</p>
<div id="main" style="width: 960px; height: 600px; margin-left: auto; margin-right: auto; margin-top: 10px">
    <div id="chart_dom" style="width: 50%;height: 100%; float: left;background-color: beige;">
        <input id="serverIP" placeholder="Enter server ip"/>
        <button id="enable_btn" ></button>
        <button id="disable_btn" ></button>


        <select id="language_select">
            <option value="eng" >English</option>
            <option value="chs" >简体中文</option>
        </select>
        <div id="interface_div" style="width: 250px">
            <button id="manual_btn" >Manual</button>
            <button id="auto_btn">Auto</button>
            <!--<div id="radioset">-->
                <!--<input type="radio" id="radio1" name="radio" value="1" checked="checked"><label id="radio1-label" for="radio1">Manual</label>-->
                <!--<input type="radio" id="radio2" name="radio" value="2" ><label id="radio2-lable" for="radio2">Auto</label>-->
            <!--</div>-->
            <div id="manual_div"></div>
            <div id="auto_div"></div>
        </div>
    </div>
    <div style="width: 50%;height: 100%; float:left">
        <div id="gameContainer"  style="width: 100%;height: 100%">

        </div>
        <div id="loader" style="width: 50%;height: 100%;left: auto">
            <!--<img class="logo" src="logo.png">-->
            <div class="spinner" style="width: 50%;float: left"></div>
            <div class="progress" style="width: 50%;float: left"><div class="full" ></div></div>
        </div>
    </div>



</div>

<div id="accordion">
    <div id="Device_0">Device_0 </div>
    <div id="xPdo_0"></div>
    <div id="Device_1">Device_1 </div>
    <div id="xPdo_1"></div>
    <div id="Device_2">Device_2 </div>
    <div id="xPdo_2"></div>
    <div id="Device_3">Device_3 </div>
    <div id="xPdo_3"></div>
    <div id="Device_4">Device_4 </div>
    <div id="xPdo_4"></div>
    <div id="Device_5">Device_5 </div>
    <div id="xPdo_5"></div>
    <div id="Device_6">Device_6 </div>
    <div id="xPdo_6"></div>
    <div id="Device_7">Device_7 </div>
    <div id="xPdo_7"></div>
    <div id="Device_8">Device_8 </div>
    <div id="xPdo_8"></div>
    <div id="Device_9">Device_9 </div>
    <div id="xPdo_9"></div>
</div>
<!--<div id="interface_div_1">-->
    <!--<div id="interface_div_2">Device_0 </div>-->
    <!--<div id="interface_div"></div>-->
<!--</div>-->


<table id="InputTable_Temp" border="1" style="width: 600px">
    <tr bgcolor="#ffe4c4">
        <td style="width: 40%">Attribute Name</td>
        <td style="width: 20%">Value</td>
    </tr>
</table>

<!--unity-->
<script>
    var gameInstance = UnityLoader.instantiate("gameContainer", "Build/8.json", {onProgress: UnityProgress});
    function UnityProgress(gameInstance, progress) {
        if (!gameInstance.Module) {
            return;
        }
        const loader = document.querySelector("#loader");
        if (!gameInstance.progress) {
            const progress = document.querySelector("#loader .progress");
            progress.style.display = "block";
            gameInstance.progress = progress.querySelector(".full");
            loader.querySelector(".spinner").style.display = "none";
        }
        gameInstance.progress.style.transform = `scaleX(${progress})`;
        if (progress === 1 && !gameInstance.removeTimeout) {
            gameInstance.removeTimeout = setTimeout(function() {
                loader.style.display = "none";
            }, 2000);
        }
    }
</script>

<script src="/socket.io/socket.io.js"></script>

<script type="text/javascript" language="javascript" charset="big5">



    var language="eng";
    $("#InputTable_Temp").hide();
    $("#accordion").hide();
    $("#interface_div").hide();
    $("#manual_div").hide();
    $("#auto_div").hide();
    if (Cookies.get("var")!=null){
        language=Cookies.get("var");
    }
    else {
        language=$("select#language_select").val();
    }

    document.getElementById("title_id").innerText=(ReturnUI_Text("Simulator|模拟器"));
    document.getElementById("manual_btn").innerText=(ReturnUI_Text("Manual|手动"));
    document.getElementById("auto_btn").innerText=(ReturnUI_Text("Auto|自动"));
    document.getElementById("enable_btn").innerText=(ReturnUI_Text("Enable|使能"));
    document.getElementById("disable_btn").innerText=(ReturnUI_Text("Disable|去使能"));
    document.title=ReturnUI_Text("Auto|自动");
    console.log(language);
    $("select#language_select").change(function(){
        console.log($(this).val());
        language=$(this).val();
        Cookies.set("var",language);
        location.reload();
    });
    var xmlDoc;
    var setupList=[];
    // var serverIP="ws://10.10.10.126:5866";
    var serverIP="ws://127.0.0.1:5866";
    var cmd_code_list=[];//发送的命令代码列表
    var cmd_code_return_list=[];//需要处理返回值的方式列表
    var ui_id_list=[];//ui id 变量名列表
    var ui_id_value_list=[];// ui id 列表
    var language_ui_id=[];//中英文切换
    var language_ui_text=[];
    var manual_init=true;
    var manual_start=false;
    var manual_stop=true;
    var auto_init=false;
    var auto_start=false;
    var auto_stop=true;
    var ip_addr = document.location.hostname;

    if (ip_addr.indexOf("localhost")===-1){
        serverIP="ws://"+ip_addr+":5866";
    }

    console.log("ip address"+ip_addr+"/ControllerUI");

    document.getElementById("serverIP").onchange=function(){
        var str=document.getElementById("serverIP").value;
        if (str!=""&&str!=null){
            serverIP="ws://"+str+":5866";
             console.log(serverIP);
             ws.close();
            buildWS();
            setTimeout("SendCmd('2&1&0&0&0&GetXml --check_none')",4000);
             }
    }

    document.getElementById("serverIP").onclick=function(){
        var pastedtext= prompt("Please paste here:", "placeholder");
        // document.getElementById("serverIP").valueOf(pastedtext);
        $("#serverIP").val(pastedtext);
        serverIP="ws://"+pastedtext+":5866";
        console.log(serverIP);
        ws.close();
        buildWS();
        setTimeout("SendCmd('2&1&0&0&0&GetXml --check_none')",4000);

    }

    document.getElementById("manual_btn").onclick=function () {
        if (auto_stop){
            // $("#manual_div").show();
            // $("#auto_div").hide();
            manual_init=true;
            auto_init=false;
            // document.getElementById("radio1").checked=true;
            // $("input[type='radio'][name='radio'][value='1']").prop("checked", "checked");
            // console.log($("input[type='radio'][name='radio']:checked").val());
            // $("#radio1").prop("checked","checked");
        }

    }

    document.getElementById("auto_btn").onclick=function () {
        if (manual_stop){
            // $("#manual_div").hide();
            // $("#auto_div").show();
            manual_init=false;
            auto_init=true;

        }
    }

    document.getElementById("enable_btn").onmousedown=function(){
        //setInterval(ReadFromServer,1000);
    }
    var repeat_read;
    var initialized=false;

    document.getElementById("enable_btn").onclick=function () {
        if (!initialized){
            SendCmd("0&1&0&0&0&"+"rc");
            gameInstance.SendMessage("empt","GetUrlFromJs",ip_addr+"/ControllerUI");
            initialized=true;
        }
        repeat_read= setInterval(ReadFromServer,100);
        //ws.close();
    }

    document.getElementById("disable_btn").onclick=function () {
        clearInterval(repeat_read);
    }

    // document.getElementById("getXml").onclick=function(){
    //     //$("#InputTable_Temp").show();
    //     SendCmd("2&1&0&0&0&GetXml --check_none");
    // }

    // $("input[name='radio']").change(function () {
    //     console.log($('input[type="radio"][name="radio"]:checked').val());
    //
    //     // if (!auto_stop) {
    //     //     $("input[type='radio'][name='radio'][value='1']").removeAttr("checked");
    //     //     $("input[type='radio'][name='radio'][value='2']").prop("checked", "checked");
    //     // }
    //     // if (!manual_stop){
    //     //     $("input[type='radio'][name='radio'][value='2']").removeAttr("checked");
    //     //     $("input[type='radio'][name='radio'][value='1']").prop("checked", "checked");
    //     // }
    //     if ($('input[type="radio"][name="radio"]:checked').val()==="1"){
    //         if (auto_stop){
    //             // $("#manual_div").show();
    //             // $("#auto_div").hide();
    //             // $("input[type='radio'][name='radio'][value='2']").removeAttr("checked", "checked");
    //             // $("input[type='radio'][name='radio'][value='1']").prop("checked", "checked");
    //
    //             manual_init=true;
    //             auto_init=false;
    //         }
    //         else {
    //             $("input[type='radio'][name='radio'][value='1']").removeAttr("checked");
    //             // $("#radio1").
    //             $("input[type='radio'][name='radio'][value='2']").prop("checked", true);
    //             $("#radio1-labe2").addClass( "ui-checkboxradio-checked", "ui-state-active" );
    //             //$("#radio2").addClass( this.icon, null, "ui-state-hover" );
    //             console.log($('input[type="radio"][name="radio"]:checked').val());
    //         }
    //     }
    //     if ($('input[type="radio"][name="radio"]:checked').val()==="2"){
    //         if (manual_stop){
    //             // $("#manual_div").show();
    //             // $("#auto_div").hide();
    //             manual_init=false;
    //             auto_init=true;
    //             // $("input[type='radio'][name='radio'][value='1']").removeAttr("checked");
    //             // $("input[type='radio'][name='radio'][value='2']").prop("checked", "checked");
    //         }
    //         else {
    //             $("input[type='radio'][name='radio'][value='2']").removeAttr("checked");
    //             $("input[type='radio'][name='radio'][value='1']").prop("checked", true);
    //             console.log($('input[type="radio"][name="radio"]:checked').val());
    //         }
    //     }
    // });

    function UpdateView() {
            if (manual_init&&auto_stop){
                $("#manual_div").show();
                $("#auto_div").hide();
            }
            if (auto_init&&manual_stop){
                $("#manual_div").hide();
                $("#auto_div").show();
            }


            if (manual_start){
                $("#id_8").show();
                $("#id_9").show();
                document.getElementById("auto_btn").disabled=true;
                document.getElementById("auto_btn").style="color:gray";
            }
            if (manual_stop){
                $("#id_8").hide();
                $("#id_9").hide();
                document.getElementById("auto_btn").disabled=false;
                document.getElementById("auto_btn").style="color:black";
            }
        if (auto_start){

            document.getElementById("manual_btn").disabled=true;
            document.getElementById("manual_btn").style="color:gray";
        }
        if (auto_stop){

            document.getElementById("manual_btn").disabled=false;
            document.getElementById("manual_btn").style="color:black";
        }
        //     if ($('input[type="radio"][name="radio"]:checked').val()==="1"){
        //         if (auto_stop){
        //             // $("#manual_div").show();
        //             // $("#auto_div").hide();
        //             $("input[type='radio'][name='radio'][value='2']").removeAttr("checked", "checked");
        //             $("input[type='radio'][name='radio'][value='1']").prop("checked", "checked");
        //
        //             manual_init=true;
        //             auto_init=false;
        //         }
        //         else {
        //             $("input[type='radio'][name='radio'][value='1']").removeAttr("checked");
        //             $("input[type='radio'][name='radio'][value='2']").prop("checked", "checked");
        //
        //         }
        //     }
        // if ($('input[type="radio"][name="radio"]:checked').val()==="2"){
        //     if (manual_stop){
        //         // $("#manual_div").show();
        //         // $("#auto_div").hide();
        //         manual_init=false;
        //         auto_init=true;
        //         $("input[type='radio'][name='radio'][value='1']").removeAttr("checked");
        //         $("input[type='radio'][name='radio'][value='2']").prop("checked", "checked");
        //     }
        //     else {
        //         $("input[type='radio'][name='radio'][value='2']").removeAttr("checked");
        //         $("input[type='radio'][name='radio'][value='1']").prop("checked", "checked");
        //     }
        // }
        console.log($('input[type="radio"][name="radio"]:checked').val());
    }

    setInterval(UpdateView,100);

    var input_id=-1;
    var ethercat_id=-1;
    var sm_id=-1;
    var pdo_id=-1;
    var pdo_entry_id=-1;

    function printNodeName(node, name) {
        if (node.nodeType == 1){
            // console.log(node.nodeName);
            // console.log(node.getAttribute("type"));
            name+=node.nodeName+":";
            //type = EthercatMotion
            if (node.getAttribute("type")=="PdoEntry"){
                pdo_entry_id++;
                // console.log("pdo Entry id: "+pdo_entry_id.toString());
                // console.log("motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString()+"_pdoEntry_table_"+pdo_id.toString());
                var t_1=document.getElementById("motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString()+"_pdoEntry_table_"+pdo_id.toString());
                var r=t_1.insertRow(-1);
                var c=r.insertCell(0);
                // c.innerHTML = node.nodeName;
                var id_str="motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString()+"_pdoEntry_"+pdo_entry_id.toString();

                c.innerHTML ="<input id=" + id_str+"_name"+" value="+node.nodeName+" style='width: 80px'/>";

                c = r.insertCell(1);
                c.innerHTML ="<input id=" + id_str+"_index"+" value="+node.getAttribute('index')+" style='width: 80px'/>";
                // console.log(c.innerHTML);
                c = r.insertCell(-1);
                c.innerHTML ="<input id="+id_str+"_subindex"+" value="+node.getAttribute('subindex')+" style='width: 80px'/>";
                c = r.insertCell(-1);
                c.innerHTML ="<input id="+id_str+"_size"+" value="+node.getAttribute('size')+" style='width: 60px'/>";

            }

            if (node.getAttribute("type")=="Pdo"){
                pdo_id++;
                pdo_entry_id=-1;
                // console.log("pdo id: "+pdo_id.toString());
                var div_pdo=document.createElement("fieldset");
                //div_pdo.innerText="pdo_"+pdo_id.toString()+" Name:"+node.nodeName+"  ";
                var div_Pdo_index=document.createElement("b");
                div_Pdo_index.innerText="index";
                div_pdo.appendChild(div_Pdo_index);
                var div_input=document.createElement("input");
                div_input.innerHTML="<input/>";
                id_str="motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString();

                div_input.id=id_str+"_index";
                div_input.value=node.getAttribute("index");
                div_pdo.appendChild(div_input);
                document.getElementById("motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()).appendChild(div_pdo);

                var  t;
                t = document.createElement('table');
                t.id="motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString()+ "_pdoEntry_table_"+pdo_id.toString();
                var r_ = t.insertRow(0);
                var c_ = r_.insertCell(0);
                c_.innerHTML = "PdoEntryName";
                c_ = r_.insertCell(1);
                c_.innerHTML = "index";
                c_ = r_.insertCell(2);
                c_.innerHTML = "subindex";
                c_ = r_.insertCell(-1);
                c_.innerHTML = "size";
                //document.getElementById("motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()).appendChild(t);
                div_pdo.appendChild(t);

                //$("#xPdo_"+(ethercat_id).toString()).append(div_pdo);

            }

            if (node.getAttribute("type")=="SyncManager"){
                sm_id++;
                pdo_id=-1;
                // console.log("sm id: "+sm_id.toString());
                var div_syncm=document.createElement("fieldset");
                div_syncm.id="motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString();
                div_syncm.innerText="sm_"+sm_id.toString();

                var btn_addPdo=document.createElement("div");
                btn_addPdo.innerHTML="<button>Add Pdo</button>";
                btn_addPdo.onclick=function(){
                    var pdo_node=xmlDoc.createElement("index_1a");
                    node.appendChild(pdo_node);
                    pdo_node.setAttribute("type","Pdo");
                    pdo_id++;
                    pdo_entry_id=-1;
                    // console.log("pdo id: "+pdo_id.toString());

                    var div_pdo=document.createElement("fieldset");
                    //div_pdo.innerText="pdo_"+pdo_id.toString()+" Name:"+node.nodeName+"  ";
                    var div_Pdo_index=document.createElement("b");
                    div_Pdo_index.innerText="index";
                    div_pdo.appendChild(div_Pdo_index);
                    var div_input=document.createElement("input");
                    div_input.innerHTML="<input/>";
                    id_str="motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString();

                    div_input.id=id_str+"_index";
                    div_input.value=node.getAttribute("index");
                    div_pdo.appendChild(div_input);
                    div_syncm.appendChild(div_pdo);
                    // document.getElementById("motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()).appendChild(div_pdo);

                    var  t;
                    t = document.createElement('table');
                    t.id="motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString()+ "_pdoEntry_table_"+pdo_id.toString();
                    var r_ = t.insertRow(0);
                    var c_ = r_.insertCell(0);
                    c_.innerHTML = "PdoEntryName";
                    c_ = r_.insertCell(1);
                    c_.innerHTML = "index";
                    c_ = r_.insertCell(2);
                    c_.innerHTML = "subindex";
                    c_ = r_.insertCell(-1);
                    c_.innerHTML = "size";
                    //document.getElementById("motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()).appendChild(t);
                    div_pdo.appendChild(t);

                    //var pdoEntryName=["status_word","mode"]
                    for (var i=0;i<5;i++){
                        var pdoEntry_node=xmlDoc.createElement("status_word");
                        pdo_node.appendChild(pdoEntry_node);
                        pdoEntry_node.setAttribute("type","PdoEntry");

                        pdo_entry_id++;
                        // console.log("pdo Entry id: "+pdo_entry_id.toString());
                        // console.log("motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString()+"_pdoEntry_table_"+pdo_id.toString());
                        var t_1=document.getElementById("motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString()+"_pdoEntry_table_"+pdo_id.toString());
                        var r=t_1.insertRow(-1);
                        var c=r.insertCell(0);
                        //c.innerHTML = "status_word";
                        id_str="motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString()+"_pdoEntry_"+pdo_entry_id.toString();;
                        c.innerHTML ="<input id=" + id_str +"_name"+" value="+pdoEntry_node.nodeName+" style='width: 80px'/>";

                        c = r.insertCell(1);
                        var id_str="motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString()+"_pdoEntry_"+pdo_entry_id.toString();
                        c.innerHTML ="<input id=" + id_str+"_index"+" value="+node.getAttribute('index')+" style='width: 80px'/>";
                        // console.log(c.innerHTML);
                        c = r.insertCell(-1);
                        c.innerHTML ="<input id="+id_str+"_subindex"+" value="+node.getAttribute('subindex')+" style='width: 80px'/>";
                        c = r.insertCell(-1);
                        c.innerHTML ="<input id="+id_str+"_size"+" value="+node.getAttribute('size')+" style='width: 60px'/>";

                    }



                }
                div_syncm.appendChild(btn_addPdo);

                document.getElementById("motion_"+ethercat_id.toString()).appendChild(div_syncm);


            }

            if (node.getAttribute("type")=="EthercatMotion"){
                ethercat_id++;
                sm_id=-1;
                // console.log("ethercat id: "+ethercat_id);
                //input UI
                $("#accordion").show();

                var div_3=document.createElement("fieldset");
                div_3.id="motion_"+ethercat_id.toString();
                div_3.innerHTML="<div></div>";
                div_3.innerText="Motion_"+ethercat_id.toString();
                // var div_5=document.createElement("b");
                // div_5.innerText="Motion "+(ethercat_id).toString()+"_Name";
                // div_3.appendChild(div_5);

                var motion_table=document.createElement("table");
                var motion_table_row=motion_table.insertRow(-1);
                id_str="motion_"+ethercat_id.toString();
                motion_table_row.innerHTML="<td>phy_id</td><td><input id="+id_str+"_phy_id"+" value="+node.getAttribute('phy_id')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>vendor_id</td><td><input id="+id_str+"_vendor_id"+" value="+node.getAttribute('vendor_id')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>product_code</td><td><input id="+id_str+"_product_code"+" value="+node.getAttribute('product_code')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>revision_num</td><td><input id="+id_str+"_revision_num"+" value="+node.getAttribute('revision_num')+" style='width: 100px' /></td>";

                motion_table_row=motion_table.insertRow(-1);
                motion_table_row.innerHTML="<td>dc_assign_activate</td><td><input id="+id_str+"_dc_assign_activate"+" value="+node.getAttribute('dc_assign_activate')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>max_pos</td><td><input id="+id_str+"_max_pos"+" value="+node.getAttribute('max_pos')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>min_pos</td><td><input id="+id_str+"_min_pos"+" value="+node.getAttribute('min_pos')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>max_vel</td><td><input id="+id_str+"_max_vel"+" value="+node.getAttribute('max_vel')+" style='width: 100px' /></td>";

                motion_table_row=motion_table.insertRow(-1);
                motion_table_row.innerHTML="<td>min_vel</td><td><input id="+id_str+"_min_vel"+" value="+node.getAttribute('min_vel')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>max_acc</td><td><input id="+id_str+"_max_acc"+" value="+node.getAttribute('max_acc')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>min_acc</td><td><input id="+id_str+"_min_acc"+" value="+node.getAttribute('min_acc')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>max_pos_following_error</td><td><input id="+id_str+"_max_pos_following_error"+" value="+node.getAttribute('max_pos_following_error')+" style='width: 100px' /></td>";

                motion_table_row=motion_table.insertRow(-1);
                motion_table_row.innerHTML="<td>max_vel_following_error</td><td><input id="+id_str+"_max_vel_following_error"+" value="+node.getAttribute('max_vel_following_error')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>pos_factor</td><td><input id="+id_str+"_pos_factor"+" value="+node.getAttribute('pos_factor')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>pos_offset</td><td><input id="+id_str+"_pos_offset"+" value="+node.getAttribute('pos_offset')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>home_pos</td><td><input id="+id_str+"_home_pos"+" value="+node.getAttribute('home_pos')+" style='width: 100px' /></td>";

                // motion_table_row.innerHTML="<td>phy_id</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('phy_id')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>vendor_id</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('vendor_id')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>product_code</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('product_code')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>revision_num</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('revision_num')+" style='width: 100px' /></td>";
                //
                // motion_table_row=motion_table.insertRow(-1);
                // motion_table_row.innerHTML="<td>dc_assign_activate</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('dc_assign_activate')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>max_pos</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_pos')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>min_pos</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('min_pos')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>max_vel</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_vel')+" style='width: 100px' /></td>";
                //
                // motion_table_row=motion_table.insertRow(-1);
                // motion_table_row.innerHTML="<td>min_vel</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('min_vel')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>max_acc</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_acc')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>min_acc</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('min_acc')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>max_pos_following_error</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_pos_following_error')+" style='width: 100px' /></td>";
                //
                // motion_table_row=motion_table.insertRow(-1);
                // motion_table_row.innerHTML="<td>max_vel_following_error</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_vel_following_error')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>pos_factor</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('pos_factor')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>pos_offset</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('pos_offset')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>home_pos</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('home_pos')+" style='width: 100px' /></td>";

                div_3.appendChild(motion_table);



                var p_=document.createElement("p");
                p_.innerHTML="<p></p>";

                div_3.appendChild(p_);

                var p_2=document.createElement("p");
                p_2.innerHTML="<p></p>";
                div_3.appendChild(p_2);
                $("#xPdo_"+(ethercat_id).toString()).append(div_3);

                $("#Device_"+(ethercat_id).toString()).show();
                $("#xPdo_"+(ethercat_id).toString()).show();
                for (var i=ethercat_id;i<12;i++){
                    $("#Device_"+(i+1).toString()).hide();
                    $("#xPdo_"+(i+1).toString()).hide();

                }

            }

            if (node.getAttribute("type")=="EthercatSlave"){
                ethercat_id++;
                sm_id=-1;
                // console.log("ethercat id: "+ethercat_id);
                //input UI
                $("#accordion").show();

                var div_3=document.createElement("fieldset");
                div_3.id="motion_"+ethercat_id.toString();
                div_3.innerHTML="<div></div>";
                div_3.innerText="Slave_"+ethercat_id.toString();
                // var div_5=document.createElement("b");
                // div_5.innerText="Motion "+(ethercat_id).toString()+"_Name";
                // div_3.appendChild(div_5);


                var motion_table=document.createElement("table");
                var motion_table_row=motion_table.insertRow(-1);
                id_str="motion_"+ethercat_id.toString();
                motion_table_row.innerHTML="<td>phy_id</td><td><input id="+id_str+"_phy_id"+" value="+node.getAttribute('phy_id')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>vendor_id</td><td><input id="+id_str+"_vendor_id"+" value="+node.getAttribute('vendor_id')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>product_code</td><td><input id="+id_str+"_product_code"+" value="+node.getAttribute('product_code')+" style='width: 100px' /></td>";
                motion_table_row.innerHTML+="<td>revision_num</td><td><input id="+id_str+"_revision_num"+" value="+node.getAttribute('revision_num')+" style='width: 100px' /></td>";

                motion_table_row=motion_table.insertRow(-1);
                motion_table_row.innerHTML="<td>dc_assign_activate</td><td><input id="+id_str+"_dc_assign_activate"+" value="+node.getAttribute('dc_assign_activate')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>max_pos</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_pos')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>min_pos</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('min_pos')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>max_vel</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_vel')+" style='width: 100px' /></td>";
                //
                // motion_table_row=motion_table.insertRow(-1);
                // motion_table_row.innerHTML="<td>min_vel</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('min_vel')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>max_acc</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_acc')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>min_acc</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('min_acc')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>max_pos_following_error</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_pos_following_error')+" style='width: 100px' /></td>";
                //
                // motion_table_row=motion_table.insertRow(-1);
                // motion_table_row.innerHTML="<td>max_vel_following_error</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_vel_following_error')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>pos_factor</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('pos_factor')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>pos_offset</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('pos_offset')+" style='width: 100px' /></td>";
                // motion_table_row.innerHTML+="<td>home_pos</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('home_pos')+" style='width: 100px' /></td>";

                div_3.appendChild(motion_table);

                var btn_1=document.createElement("div");
                //btn_1.innerText="MotionConfig";
                //btn_1.id="btn_"+ethercat_id.toString();
                //$("#"+"btn_"+ethercat_id.toString()).button();
                //btn_1.button();
                btn_1.innerHTML="<button >MotionConfig</button>"
                btn_1.onclick=function () {
                    if (node.getAttribute("type")!="EthercatMotion") {
                        node.setAttribute("type","EthercatMotion");


                        motion_table_row.innerHTML+="<td>max_pos</td><td><input id="+id_str+"_max_pos"+" value="+node.getAttribute('max_pos')+" style='width: 100px' /></td>";
                        motion_table_row.innerHTML+="<td>min_pos</td><td><input id="+id_str+"_min_pos"+" value="+node.getAttribute('min_pos')+" style='width: 100px' /></td>";
                        motion_table_row.innerHTML+="<td>max_vel</td><td><input id="+id_str+"_max_vel"+" value="+node.getAttribute('max_vel')+" style='width: 100px' /></td>";

                        motion_table_row=motion_table.insertRow(-1);
                        motion_table_row.innerHTML="<td>min_vel</td><td><input id="+id_str+"_min_vel"+" value="+node.getAttribute('min_vel')+" style='width: 100px' /></td>";
                        motion_table_row.innerHTML+="<td>max_acc</td><td><input id="+id_str+"_max_acc"+" value="+node.getAttribute('max_acc')+" style='width: 100px' /></td>";
                        motion_table_row.innerHTML+="<td>min_acc</td><td><input id="+id_str+"_min_acc"+" value="+node.getAttribute('min_acc')+" style='width: 100px' /></td>";
                        motion_table_row.innerHTML+="<td>max_pos_following_error</td><td><input id="+id_str+"_max_pos_following_error"+" value="+node.getAttribute('max_pos_following_error')+" style='width: 100px' /></td>";

                        motion_table_row=motion_table.insertRow(-1);
                        motion_table_row.innerHTML="<td>max_vel_following_error</td><td><input id="+id_str+"_max_vel_following_error"+" value="+node.getAttribute('max_vel_following_error')+" style='width: 100px' /></td>";
                        motion_table_row.innerHTML+="<td>pos_factor</td><td><input id="+id_str+"_pos_factor"+" value="+node.getAttribute('pos_factor')+" style='width: 100px' /></td>";
                        motion_table_row.innerHTML+="<td>pos_offset</td><td><input id="+id_str+"_pos_offset"+" value="+node.getAttribute('pos_offset')+" style='width: 100px' /></td>";
                        motion_table_row.innerHTML+="<td>home_pos</td><td><input id="+id_str+"_home_pos"+" value="+node.getAttribute('home_pos')+" style='width: 100px' /></td>";

                        // motion_table_row.innerHTML+="<td>max_pos</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_pos')+" style='width: 100px' /></td>";
                        // motion_table_row.innerHTML+="<td>min_pos</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('min_pos')+" style='width: 100px' /></td>";
                        // motion_table_row.innerHTML+="<td>max_vel</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_vel')+" style='width: 100px' /></td>";
                        //
                        // motion_table_row=motion_table.insertRow(-1);
                        // motion_table_row.innerHTML="<td>min_vel</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('min_vel')+" style='width: 100px' /></td>";
                        // motion_table_row.innerHTML+="<td>max_acc</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_acc')+" style='width: 100px' /></td>";
                        // motion_table_row.innerHTML+="<td>min_acc</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('min_acc')+" style='width: 100px' /></td>";
                        // motion_table_row.innerHTML+="<td>max_pos_following_error</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_pos_following_error')+" style='width: 100px' /></td>";
                        //
                        // motion_table_row=motion_table.insertRow(-1);
                        // motion_table_row.innerHTML="<td>max_vel_following_error</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('max_vel_following_error')+" style='width: 100px' /></td>";
                        // motion_table_row.innerHTML+="<td>pos_factor</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('pos_factor')+" style='width: 100px' /></td>";
                        // motion_table_row.innerHTML+="<td>pos_offset</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('pos_offset')+" style='width: 100px' /></td>";
                        // motion_table_row.innerHTML+="<td>home_pos</td><td><input id="+(input_id++).toString()+" value="+node.getAttribute('home_pos')+" style='width: 100px' /></td>";

                    }


                }
                div_3.appendChild(btn_1);


                var p_=document.createElement("p");
                p_.innerHTML="<p></p>";

                div_3.appendChild(p_);

                var p_2=document.createElement("p");
                p_2.innerHTML="<p></p>";
                div_3.appendChild(p_2);
                $("#xPdo_"+(ethercat_id).toString()).append(div_3);

                $("#Device_"+(ethercat_id).toString()).show();
                $("#xPdo_"+(ethercat_id).toString()).show();
                for (var i=ethercat_id;i<12;i++){
                    $("#Device_"+(i+1).toString()).hide();
                    $("#xPdo_"+(i+1).toString()).hide();

                }

            }

            if (node.hasChildNodes()) {
                var sonNodes = node.childNodes;
                for (var j = 0; j < sonNodes.length; j++) {
                    if (sonNodes[j].nodeType == 1) {
                        printNodeName(sonNodes[j],name);
                    }
                }
            }
        }
    }

    function CollectNodeName(node, name) {
        if (node.nodeType == 1){
            // console.log(node.nodeName);
            name+=node.nodeName+":";
            if (node.getAttribute("type")=="PdoEntry"){
                pdo_entry_id++;
                // console.log("pdo Entry id: "+pdo_entry_id.toString());
                // console.log("motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString()+"_pdoEntry_table_"+pdo_id.toString());

                id_str="motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString()+"_pdoEntry_"+pdo_entry_id.toString();

                console.log(id_str+"_name");
                console.log($("#"+id_str+"_name").val());
                var re_node=xmlDoc.createElement($("#"+id_str+"_name").val());
                re_node.setAttribute("type","PdoEntry");
                node.parentNode.replaceChild(re_node,node);

                re_node.setAttribute("index",$("#"+id_str+"_index").val());
                console.log(id_str+"_index");
                re_node.setAttribute("subindex",$("#"+id_str+"_subindex").val());
                re_node.setAttribute("size",$("#"+id_str+"_size").val());

                // node.setAttribute("index",$("#"+(input_id++).toString()).val());
                // node.setAttribute("subindex",$("#"+(input_id++).toString()).val());
                // node.setAttribute("size",$("#"+(input_id++).toString()).val());


            }
            if (node.getAttribute("type")=="Pdo"){
                pdo_id++;
                pdo_entry_id=-1;
                // console.log("pdo id: "+pdo_id.toString());
                id_str="motion_"+ethercat_id.toString()+"_syncm_"+sm_id.toString()+"_pdo_"+pdo_id.toString();
                node.setAttribute("index",$("#"+id_str+"_index").val());

                // node.setAttribute("index",$("#"+(input_id++).toString()).val());


            }
            if (node.getAttribute("type")=="SyncManager"){
                sm_id++;
                pdo_id=-1;
                // console.log("sm id: "+sm_id.toString());


            }
            if (node.getAttribute("type")=="EthercatMotion"){
                ethercat_id++;
                sm_id=-1;
                // console.log("ethercat id: "+ethercat_id);

                var id_str="motion_"+ethercat_id.toString();
                node.setAttribute("phy_id",$("#"+id_str+"_phy_id").val());
                node.setAttribute("vendor_id",$("#"+id_str+"_vendor_id").val());
                node.setAttribute("product_code",$("#"+id_str+"_product_code").val());
                node.setAttribute("revision_num",$("#"+id_str+"_revision_num").val());
                node.setAttribute("dc_assign_activate",$("#"+id_str+"_dc_assign_activate").val());
                node.setAttribute("max_pos",$("#"+id_str+"_max_pos").val());
                node.setAttribute("min_pos",$("#"+id_str+"_min_pos").val());
                node.setAttribute("max_vel",$("#"+id_str+"_max_vel").val());
                node.setAttribute("min_vel",$("#"+id_str+"_min_vel").val());
                node.setAttribute("max_acc",$("#"+id_str+"_max_acc").val());
                node.setAttribute("min_acc",$("#"+id_str+"_min_acc").val());
                node.setAttribute("max_pos_following_error",$("#"+id_str+"_max_pos_following_error").val());
                node.setAttribute("max_vel_following_error",$("#"+id_str+"_max_vel_following_error").val());
                node.setAttribute("pos_factor",$("#"+id_str+"_pos_factor").val());
                node.setAttribute("pos_offset",$("#"+id_str+"_pos_offset").val());
                node.setAttribute("home_pos",$("#"+id_str+"_home_pos").val());
                // node.setAttribute("phy_id",$("#"+(input_id++).toString()).val());
                // node.setAttribute("vendor_id",$("#"+(input_id++).toString()).val());
                // node.setAttribute("product_code",$("#"+(input_id++).toString()).val());
                // node.setAttribute("revision_num",$("#"+(input_id++).toString()).val());
                // node.setAttribute("dc_assign_activate",$("#"+(input_id++).toString()).val());
                // node.setAttribute("max_pos",$("#"+(input_id++).toString()).val());
                // node.setAttribute("min_pos",$("#"+(input_id++).toString()).val());
                // node.setAttribute("max_vel",$("#"+(input_id++).toString()).val());
                // node.setAttribute("min_vel",$("#"+(input_id++).toString()).val());
                // node.setAttribute("max_acc",$("#"+(input_id++).toString()).val());
                // node.setAttribute("min_acc",$("#"+(input_id++).toString()).val());
                // node.setAttribute("max_pos_following_error",$("#"+(input_id++).toString()).val());
                // node.setAttribute("max_vel_following_error",$("#"+(input_id++).toString()).val());
                // node.setAttribute("pos_factor",$("#"+(input_id++).toString()).val());
                // node.setAttribute("pos_offset",$("#"+(input_id++).toString()).val());
                // node.setAttribute("home_pos",$("#"+(input_id++).toString()).val());



            }

            if (node.hasChildNodes()) {
                var sonNodes = node.childNodes;
                for (var j = 0; j < sonNodes.length; j++) {
                    if (sonNodes[j].nodeType == 1) {
                        CollectNodeName(sonNodes[j],name);
                    }
                }
            }
        }
    }

    function GetXmlDoc(data){
        //
        // console.log(data);
        var parser=new DOMParser();
        xmlDoc=parser.parseFromString(data,"text/xml");
        //master
        // var master_node=xmlDoc.getElementsByTagName("master");
        // printNodeName(master_node[0],"");

        //plan_interface
        var interface_node=xmlDoc.getElementsByTagName("interface_root");
        ShowPlanInterface(interface_node[0]);

    }

    function ShowPlanInterface(node){

        GetUI_ID_List(node);
        var cmd_interface_pool_node=node.getElementsByTagName("cmd_interface_pool_object");

        var cmd_panel_node=cmd_interface_pool_node[0].childNodes;
        for (var i=0;i<cmd_panel_node.length;i++){
            if (cmd_panel_node[i].nodeType===1&&cmd_panel_node[i].nodeName==="panel"){
                if (cmd_panel_node[i].getAttribute("text")==="Manual|手动") {
                    CreatePanel(cmd_panel_node[i],document.getElementById("manual_div"));
                }
                if (cmd_panel_node[i].getAttribute("text")==="Auto|自动") {
                    CreatePanel(cmd_panel_node[i],document.getElementById("auto_div"));
                }
            }

        }

        var query_interface_pool_node=node.getElementsByTagName("query_interface_pool_object");
        var query_panel_node=query_interface_pool_node[0].childNodes;
        for (var j = 0; j < query_panel_node.length;j++){
            if (query_panel_node[j].nodeType===1&&query_panel_node[j].nodeName==="panel"){
                CreatePanel(query_panel_node[j],document.getElementById("interface_div"));
            }

        }

        SetUITheme();
    }

    function GetUI_ID_List(node) {
        var id_pool_node=node.getElementsByTagName("ui_id_pool_object");
        var id_list=id_pool_node[0].childNodes;
        for (var i=0;i<id_list.length;i++){

            if (id_list[i].nodeType===1){
                ui_id_list[ui_id_list.length]=id_list[i].nodeName;
                ui_id_value_list[ui_id_value_list.length]=id_list[i].getAttribute("value");
            }
        }
    }

    function ReturnUI_ID(str) {
        var index_1=ui_id_list.indexOf(str);
        if (index_1!=-1){
            return ui_id_value_list[index_1];

        }else {return null;}
    }

    function ReturnUI_Text(str) {
        var str_list=str.split('|');
        switch (language) {
            case "eng":
                return str_list[0];
            case "chs":
                return str_list[1];
            default:
                return null;

        }

    }

    function CreatePanel(node,father) {
        var panel_id=ReturnUI_ID( node.getAttribute("id"));
        var panel_text=node.getAttribute("text");
        var div_syncm=document.createElement("fieldset");
        div_syncm.style="width:400px";
        div_syncm.id=panel_id;
        div_syncm.innerText=ReturnUI_Text(panel_text);
        div_syncm.appendChild(document.createElement("p"));
        language_ui_id[language_ui_id.length]=panel_id;
        language_ui_text[language_ui_text.length]=panel_text;
        // console.log(div_syncm.innerText);
        var sonNodes=node.childNodes;
        for (var j=0;j<sonNodes.length;j++){
            if (sonNodes[j].nodeType===1){
                if (sonNodes[j].nodeName==="panel"){
                    CreatePanel(sonNodes[j],div_syncm);
                }
                if (sonNodes[j].nodeName==="input"){
                    CreateInput(sonNodes[j],div_syncm);
                }
                if (sonNodes[j].nodeName==="button"){
                    CreateButton(sonNodes[j],div_syncm);
                }
                if (sonNodes[j].nodeName==="label"){
                    CreateLabel(sonNodes[j],div_syncm);
                }
            }
        }
        father.appendChild(document.createElement("h"));
        father.appendChild(div_syncm);
    }

    function CreateInput(node,father) {
        var input_para=document.createElement("b");
        input_para.innerText="  "+node.getAttribute("parameter");
        father.appendChild(input_para);
        var input_div=document.createElement("input");
        input_div.id=ReturnUI_ID(node.getAttribute("id"));
        input_div.value=node.getAttribute("default");
        input_div.style="width:80px";
        father.appendChild(input_div);
    }

    function CreateLabel(node,father) {
        var input_para=document.createElement("input");
        input_para.id=ReturnUI_ID(node.getAttribute("id"));
        // console.log("label id:"+input_para.id);
        // input_para.innerText="  ";
        input_para.setAttribute("type","text");
        input_para.setAttribute("value","");
        father.appendChild(input_para);
        // var input_div=document.createElement("input");
        // input_div.id=node.getAttribute("id");
        // input_div.value=node.getAttribute("default");
        // input_div.style="width:80px";
        // father.appendChild(input_div);
    }

    function CreateButton(node,father) {

        var btn_cmd=document.createElement("button");

        // btn_cmd.innerHTML="<button>"+node.getAttribute('text')+"</button>";
        var btn_text=node.getAttribute('text');
        btn_cmd.innerText=ReturnUI_Text(btn_text);
        var btn_id=ReturnUI_ID(node.getAttribute("id"));
        btn_cmd.id=btn_id;
        language_ui_id[language_ui_id.length]=btn_id;
        language_ui_text[language_ui_text.length]=btn_text;

        btn_cmd.style="width: 80px; position: relative; margin-left: 20px;margin-top: 10px";
        father.appendChild(btn_cmd);

        // $("#"+btn_id).css({position: "absolute",'top':100,'left':50,'z-index':2});

        if (node.getAttribute("cmd")!=null){

            var cmd_str_1=node.getAttribute("cmd");
            var cmd_return_str=node.getAttribute("return_attached");
            if (node.getAttribute("repeat")!=1){//down repeat
                btn_cmd.onclick=function(){
                    Btn_cmd_onclick(cmd_str_1,cmd_return_str);
                }
            }
            if (node.getAttribute("repeat")==="1"){//down repeat
                console.log("repeat");
                var repeat_1;
                btn_cmd.onmousedown=function(){
                   repeat_1=  setInterval(Btn_cmd_onclick_repeat(cmd_str_1,cmd_return_str),100);
                }
                btn_cmd.onmouseup=function () {
                    clearInterval(repeat_1);
                }
                
            }
        }
        if (node.getAttribute("query_item")!=null){
            var query_str=node.getAttribute("query_item");
            var query_return_str=node.getAttribute("return_attached");
            btn_cmd.onclick=function () {
                Btn_query_onclick(query_str,query_return_str)
            }
        }
    }


    function Btn_cmd_onclick_repeat(id,id2) {
        return function()
        {
            //foo(id,id2);
           Btn_cmd_onclick(id,id2);
        }
    }

    function Btn_cmd_onclick(str,return_str){
        if (str.indexOf("$")!=-1) {
            // console.log(str);
            var index_1 = str.indexOf("{");
            // console.log("index_1: " + index_1);

            var index_2 = str.indexOf("}");
            // console.log("index_2: " + index_2);
            var id_str = str.substr(index_1 + 1, index_2 - index_1 - 1);
            // console.log(id_str);
            var id_value = $("#" + id_str).val();
            // console.log(id_value);
            var old_str="${"+id_str+"}";
            // console.log("old str "+old_str);
            // console.log(str.replace(old_str,id_value));
            Btn_cmd_onclick(str.replace(old_str,id_value));
        }

        if (str.indexOf("$")==-1){
            var myDate=new Date();
            var now=myDate.getTime();
            // console.log("time:"+now);

            // console.log("0&1&"+now+"&0&0&"+str);
            SendCmd("0&1&"+now+"&0&0&"+str);
            cmd_code_list[cmd_code_list.length]=now;//储存已发送的cmd code
            cmd_code_return_list[cmd_code_return_list.length]=return_str;//储存cmd的返回操作
            if (str.indexOf("mm --start")!=-1){
                manual_start=true;
                manual_stop=false;
            }
            if (str.indexOf("mm --stop")!=-1){
                manual_stop=true;
                manual_start=false;
            }
            if (str.indexOf("am --start")!=-1){
                auto_start=true;
                auto_stop=false;
            }
            if (str.indexOf("am --stop")!=-1){
                auto_stop=true;
                auto_start=false;
            }
        }
    }

    function Btn_query_onclick(str,return_str){
        var myDate=new Date();
        var now=myDate.getTime();
        // var now=myDate.myDate.toLocaleTimeString();
        // console.log("time:"+now);

        // console.log("send :"+"5&1&"+now+"&0&0&"+str);
        SendCmd("5&1&"+now+"&0&0&"+str);
        cmd_code_list[cmd_code_list.length]=now;//储存已发送的cmd code
        cmd_code_return_list[cmd_code_return_list.length]=return_str;//储存cmd的返回操作

    }

</script>


<script type="text/javascript">

    var ws;

    function PackBotCmd(str) {
        //1&1&0&0&0&Read --check_none
        var strArray=str.split("&");
        if (strArray.length>3){
            var cmd_id=parseInt(strArray[0]);
            var cmd_option=parseInt((strArray[1]));
            var cmd_code=parseInt((strArray[2]));

            // console.log("res-1:"+cmd_code);
            var res_2=parseInt((strArray[3]));
            var res_3=parseInt((strArray[4]));

            var mes_length=strArray[5].length;
            var buffer=new ArrayBuffer(40+mes_length);
            var headView=new DataView(buffer);
            headView.setInt32(0,mes_length,true);
            headView.setInt32(4,cmd_id,true);
            headView.setInt32(8,cmd_option,true);
            headView.setFloat64(16,cmd_code,true);
            // console.log("cmd_code:"+headView.getFloat64(16,true));
            headView.setInt32(24,res_2,true);
            headView.setInt32(32,res_3,true);
            for (var i=0;i<mes_length;i++){
                headView.setUint8(40+i,strArray[5].charCodeAt(i));
            }

            ws.send(headView.buffer);
            // console.log("send cmd"+headView.buffer.byteLength);

        }
    }

    //可以处理中文
    function Utf8ArrayToStr(array) {
        var out, i, len, c;
        var char2, char3;

        out = "";
        len = array.length;
        i = 0;
        while(i < len) {
            c = array[i++];
            switch(c >> 4)
            {
                case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7:
                // 0xxxxxxx
                out += String.fromCharCode(c);
                break;
                case 12: case 13:
                // 110x xxxx   10xx xxxx
                char2 = array[i++];
                out += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));
                break;
                case 14:
                    // 1110 xxxx  10xx xxxx  10xx xxxx
                    char2 = array[i++];
                    char3 = array[i++];
                    out += String.fromCharCode(((c & 0x0F) << 12) |
                        ((char2 & 0x3F) << 6) |
                        ((char3 & 0x3F) << 0));
                    break;
            }
        }

        return out;
    }

    function AnalizeBotData(buffer) {
        var dataView=new DataView(buffer);
        var cmd_length=dataView.getInt32(0);
        // console.log("receive cmd_length:"+cmd_length);
        var cmd_id=dataView.getInt32(4,true);
        // console.log("receive cmd_id:"+cmd_id);
        var cmd_code=dataView.getFloat64(16,true);
        // console.log(("receive cmd_code:"+cmd_code));

        var getMess;

        //return xml
        if (cmd_id===2){
            // getMess=String.fromCharCode.apply(null,new Uint8Array(buffer,40));
            getMess=Utf8ArrayToStr(new Uint8Array(buffer,40));
            // console.log(getMess);
            GetXmlDoc(getMess);
        }
        //return float message
        if (cmd_id===0){
            // var step=new Array();
            // for(var i=0;i<(dataView.length-40)/8;i++){
            //     step[i]=dataView.getFloat64(432+i*8);
            // }

        }
        //return float
        if (cmd_id===1){

            var pq="";
            console.log("data view length:"+buffer.byteLength)
            for(var i=0;i<(buffer.byteLength-40)/8;i++){
                if (i!=0){
                    pq+="&"+dataView.getFloat64(40+i*8,true).toString();
                }
                if (i===0){
                    pq+=dataView.getFloat64(40+i*8,true).toString();
                }


            }
            console.log("send PQ to UNity:"+pq);
            gameInstance.SendMessage("empt","ReceiveDataFromJs",pq);

           //  var return_str=String.fromCharCode.apply(null,new Uint8Array(buffer,40));
           // if (cmd_code_list.indexOf(cmd_code)!=-1){
           //     var cmd_code_index=cmd_code_list.indexOf(cmd_code);
           //     var code_return_str=cmd_code_return_list[cmd_code_index];
           //
           //     var return_str_splitlist=return_str.split(' ');
           //     var code_return_str_splitList=code_return_str.split(' ');
           //     for (var i=0;i<return_str_splitlist.length;i++){
           //         if (code_return_str_splitList[i].indexOf("$")!=-1);
           //         var index_1=code_return_str_splitList[i].indexOf(("{"));
           //         var index_2=code_return_str_splitList[i].indexOf("}");
           //         var ui_id_str=code_return_str_splitList[i].substr(index_1+1,index_2-index_1-1);
           //         var valude_str=return_str_splitlist[i].substr(index_1-1,return_str_splitlist[i].length-index_1+1);
           //         $("#" + ui_id_str).val=valude_str;
           //     }
           //     cmd_code_list.splice(cmd_code_index,1);
           //     cmd_code_return_list.splice(cmd_code_index,1);
           //     //Motion -m=5 --pos=6
           //     //Motion -m=${id_4} --pos=
           // }
        }

        //return query
        if (cmd_id===5){
            var return_str=String.fromCharCode.apply(null,new Uint8Array(buffer,40));
            // console.log("receive query :"+return_str);
            if (cmd_code_list.indexOf(cmd_code)!=-1){
                var cmd_code_index=cmd_code_list.indexOf(cmd_code);
                // console.log("cmd_code_index: "+cmd_code_index);
                var code_return_str=cmd_code_return_list[cmd_code_index];
                if (code_return_str.indexOf("$")!=-1){
                    var index_1=code_return_str.indexOf("{");
                    var index_2=code_return_str.indexOf("}");
                    var id_str=code_return_str.substr(index_1+1,index_2-index_1-1);
                    // console.log("id_str: "+id_str);
                    // $("#" + id_str).setAttribute("value",return_str);
                    $("#" + id_str).val(return_str);
                    // document.getElementById(id_str).innerText=return_str;
                    // console.log("label str:"+$("#" + id_str).value);
                }
                cmd_code_list.splice(cmd_code_index,1);
                cmd_code_return_list.splice(cmd_code_index,1);
            }
        }
    }

    function buildWS(cmd) {
        ws=new WebSocket(serverIP);

        ws.onopen=function (evt) {
            console.log("Connection open...");
            if (cmd!=null){
                SendCmd(cmd);
                console.log(cmd);
            }


        }
        ws.onmessage=function (evt) {
            if (typeof evt.data=== String){
                console.log("Received "+evt.data);
                receiveStr=evt.data;
            }
            if (evt.data instanceof ArrayBuffer){
                console.log("receive byte"+evt.data.byteLength);
                AnalizeBotData(evt.data);
            }


        }
        ws.onclose=function (evt) {
            console.log("closed");
        }
    }

    buildWS();

    setTimeout("SendCmd('2&1&0&0&0&GetXml --check_none')",4000);

    function SendCmd(cmd){
        switch (ws.readyState) {
            case WebSocket.CONNECTING:
                break;
            case WebSocket.OPEN:
                ws.binaryType='arraybuffer';
                PackBotCmd(cmd);
                break;
            case  WebSocket.CLOSING:
                break;
            case WebSocket.CLOSED:
                buildWS(cmd);
                //setTimeout("SendCmd(cmd)",4000);
                break;
        }
    }

    function ReadFromServer(){
        switch (ws.readyState) {
            case WebSocket.CONNECTING:
                break;
            case WebSocket.OPEN:
                ws.binaryType='arraybuffer';
                PackBotCmd("1&1&0&0&0&Read --check_none");
                //ws.send(PackBotCmd("1&1&0&0&0&Read --check_none"));
                //ws.send("hello");
                //CheckData(receiveStr);
                break;
            case  WebSocket.CLOSING:
                break;
            case WebSocket.CLOSED:
                buildWS();
                break;
        }


    }


</script>


<script type="text/javascript">
    $("#btn_0").button();
    $("#btn_1").button();
    $("#getXml").button();
    $("#saveXml").button();
    $("#auto_btn").button();
    //$("#manual_btn").button();
    $("#run").button();
    $( "#accordion" ).accordion({
        heightStyle:"content",
        collapsible: "true"

    });
    $("button").button();
    function SetUITheme(){
        setTimeout("$(\"button\").button()",5050);
        setTimeout("$(\"button\").width(80)",5050);
        setTimeout("$(\"#interface_div\").show()",5065);
    }

    // $( "#interface_div_1" ).accordion({
    //     heightStyle:"content",
    //     collapsible: "true"
    //
    // });

</script>
</body>
</html>
