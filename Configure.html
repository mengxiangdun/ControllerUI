<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Controller Configure</title>
    <link rel='stylesheet' href='./style.css' />
    <script src="external/jquery/jquery.js"></script>
    <script src="jquery-ui.js"></script>
    <script src="ControllerJS.js"></script>
    <link href="jquery-ui.css" rel="stylesheet">
    <script src="external/codemirror.js"></script>
    <link href="external/codemirror.css" rel="stylesheet">
    <script src="external/xml.js"></script>

</head>
<body>
<button id="btn_download">Download</button>
<button id="btn_upload">Upload</button>
<p/>
<textarea id="text_area" rows="30" cols="150"></textarea>
<script>
    // var serverIP="ws://127.0.0.1:5866";
    var serverIP="ws://192.168.1.13:5866";
    var ws;
    var xmlDoc;
    buildWS();
    setTimeout(QueryXml,3500);
    var xmlStr;
    function GetXmlDoc(data){
        var parser=new DOMParser();
        xmlDoc=parser.parseFromString(data,"text/xml");
        showXml(data);
        xmlStr=data;
        //document.getElementById("text_area").innerText=data;

    }

    var mytextArea=document.getElementsByTagName("text_area");
    // var codeMirrorEditor=CodeMirror.fromTextArea(mytextArea,{
    //     mode:"text/html",
    //     lineNumber:true
    // });

    document.getElementById("btn_upload").onclick=function(){
        UpLoad();
    }
    document.getElementById("btn_download").onclick=function(){
        Download();
    }
    $("button").button();

    function Download() {
        setTimeout(QueryXml,3500);
    }

    function UpLoad() {
        // var newXml=document.getElementById("text_area").innerText;
        var newXml =$('#text_area').val();
        var str= newXml.split('\n').join('');
        console.log("new xml: "+str);
        SendCmd("set_xml --xml={"+str+"}","");
    }

    function showXml(text){
        // text = $('#xmlContent').val();

        //去掉多余的空格
        text = '\n' + text.replace(/(<\w+)(\s.*?>)/g,function($0, name, props) {
            return name + ' ' + props.replace(/\s+(\w+=)/g," $1");
        }).replace(/>\s*?</g,">\n<");

        //把注释编码
        text = text.replace(/\n/g,'\r').replace(/<!--(.+?)-->/g,function($0, text)
        {
            var ret = '<!--' + escape(text) + '-->';
            return ret;
        }).replace(/\r/g,'\n');

        //调整格式
        var rgx = /\n(<(([^\?]).+?)(?:\s|\s*?>|\s*?(\/)>)(?:.*?(?:(?:(\/)>)|(?:<(\/)\2>)))?)/mg;
        var nodeStack = [];
        var output = text.replace(rgx,function($0,all,name,isBegin,isCloseFull1,isCloseFull2 ,isFull1,isFull2){
            var isClosed = (isCloseFull1 == '/') || (isCloseFull2 == '/' ) || (isFull1 == '/') || (isFull2 == '/');
            var prefix = '';
            if(isBegin == '!')
            {
                prefix = getPrefix(nodeStack.length);
            }
            else
            {
                if(isBegin != '/')
                {
                    prefix = getPrefix(nodeStack.length);
                    if(!isClosed)
                    {
                        nodeStack.push(name);
                    }
                }
                else
                {
                    nodeStack.pop();
                    prefix = getPrefix(nodeStack.length);
                }

            }
            var ret =  '\n' + prefix + all;
            return ret;
        });

        var prefixSpace = -1;
        var outputText = output.substring(1);

        //把注释还原并解码，调格式
        outputText = outputText.replace(/\n/g,'\r').replace(/(\s*)<!--(.+?)-->/g,function($0, prefix,  text)
        {
            if(prefix.charAt(0) == '\r')
                prefix = prefix.substring(1);
            text = unescape(text).replace(/\r/g,'\n');
            var ret = '\n' + prefix + '<!--' + text.replace(/^\s*/mg, prefix ) + '-->';
            return ret;
        });
        //alert(outputText);

        outputText=	outputText.replace(/\s+$/g,'').replace(/\r/g,'\r\n');

        $('#text_area').val(outputText);

        //div内展示，需替换“<”以及“>”
        /*		var reg = new RegExp("<","g");//g,表示全部替换。
                outputText = outputText.replace(reg,"<");
                var reg2 = new RegExp(">","g");//g,表示全部替换。
                outputText = outputText.replace(reg2,">");
                $('#container').html(outputText);
                alert(outputText);*/

    }

    function getPrefix(prefixIndex) {
        var span = '    ';
        var output = [];
        for(var i = 0 ; i < prefixIndex; ++i)
        {
            output.push(span);
        }
        return output.join('');
    }
</script>
</body>
</html>

